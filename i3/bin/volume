#!/bin/bash

channel=$(pacmd list-sinks | grep '* index:' | cut -d':' -f2 | sed 's/ //')

retrieve_volume() {
    ~/.config/i3/bin/pulsehelper retrieve-volume "$channel"
}

print_volume() {
    if [[ "$(~/.config/i3/bin/pulsehelper is-muted "$channel")" == "1" ]]; then
        echo "MUTE"
    else
        echo "$(retrieve_volume)%"
    fi
}

inc() {
    if [[ "$(retrieve_volume)" -lt "100"  ]]; then
        pactl set-sink-volume "$channel" +5%
    fi
}

dec() {
    pactl set-sink-volume "$channel" -5%
}

mute() {
    pactl set-sink-mute "$channel" toggle
}

change_output_device() {
    sink_description=$(~/.config/i3/bin/pulsehelper list-sinks "$channel" | ~/.config/i3/bin/menu | sed 's/^* //')
    sink=$(~/.config/i3/bin/pulsehelper find-sink-by-description "$sink_description")

    if [[ ! -z "$sink" ]]; then
        pacmd set-default-sink "$sink"
        for input in $(~/.config/i3/bin/pulsehelper list-sink-inputs); do
            pacmd move-sink-input "$input" "$sink"
        done
    fi
}

if [[ ! -z "$BLOCK_BUTTON" ]]; then
    case "$BLOCK_BUTTON" in
        1) pavucontrol ;;
        2) mute ;;
        3) change_output_device;;
        4) inc ;;
        5) dec ;;
    esac
elif [[ ! -z "$1" ]]; then
    case "$1" in
        up) inc ;;
        down) dec ;;
        mute) mute ;;
    esac
fi

print_volume